<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Schedule Manager</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    
    <!-- iOS App Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Schedule">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Schedule Manager">
    <meta name="theme-color" content="#6366f1">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Firebase SDK (v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
        import {
            getDatabase,
            ref,
            set,
            onValue,
            onChildAdded,
            onChildChanged,
            onChildRemoved,
            push,
            update,
            remove,
            get
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhYTiWflm90SZTySJMDlBpGu7WHzkUaL4",
            authDomain: "manager-8ac68.firebaseapp.com",
            databaseURL: "https://manager-8ac68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "manager-8ac68",
            storageBucket: "manager-8ac68.firebasestorage.app",
            messagingSenderId: "978586727124",
            appId: "1:978586727124:web:34e5fe89cc51f35b37c141",
            measurementId: "G-XPC0DXSBNZ"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        window.firebase = { app, analytics, db, ref, set, onValue, onChildAdded, onChildChanged, onChildRemoved, push, update, remove, get };

        // Mobile Zoom Prevention
        (function() {
            // Prevent zoom on input focus for mobile devices
            function preventZoom() {
                const viewport = document.querySelector('meta[name=viewport]');
                if (viewport) {
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height';
                }
            }

            // Apply zoom prevention immediately
            preventZoom();

            // Re-apply on orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(preventZoom, 500);
            });

            // Handle viewport resize for mobile Safari
            let resizeTimeout = null;
            window.addEventListener('resize', function() {
                // Debounce resize events
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
                resizeTimeout = setTimeout(function() {
                    preventZoom();
                    resizeTimeout = null;
                }, 100);
            });

            // Prevent zoom on focus for iOS
            document.addEventListener('focusin', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    e.target.style.fontSize = '16px';
                }
            });

            // Reset viewport on page load and visibility change
            document.addEventListener('DOMContentLoaded', preventZoom);
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    preventZoom();
                }
            });

            // Additional iOS-specific prevention
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                window.addEventListener('gesturestart', function(e) {
                    e.preventDefault();
                });
            }
        })();

    </script>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" fill="none">
                    <defs>
                        <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Calendar body -->
                    <rect x="4" y="6" width="16" height="16" rx="2" fill="none" stroke="url(#iconGradient)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <!-- Folded page -->
                    <path d="M4 6 L4 8 Q4 6 6 6 L10 6" fill="none" stroke="url(#iconGradient)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 8 L4 10 Q4 8 6 8 L10 8" fill="none" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.6"/>
                    <!-- Date line -->
                    <line x1="4" y1="11" x2="20" y2="11" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round"/>
                    <!-- Clock (integrated design) -->
                    <circle cx="20" cy="7" r="3.5" fill="none" stroke="url(#iconGradient)" stroke-width="2"/>
                    <line x1="20" y1="7" x2="20" y2="4.5" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round"/>
                    <line x1="20" y1="7" x2="22.2" y2="7" stroke="url(#iconGradient)" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="header-controls">
                <div class="date-navigation">
                    <button id="prevDay" class="nav-btn" aria-label="Previous Day/Week">←</button>
                    <span id="currentDate" class="current-date"></span>
                    <button id="nextDay" class="nav-btn" aria-label="Next Day/Week">→</button>
                    <button id="todayBtn" class="today-btn">Today</button>
                </div>
                <div class="view-toggle">
                    <div id="googleSyncIndicator" class="google-sync-indicator status-unsynced"></div>
                    <button id="dayViewBtn" class="view-btn active">Day</button>
                    <button id="weekViewBtn" class="view-btn">Week</button>
                    <button id="monthViewBtn" class="view-btn">Month</button>
                </div>
            </div>
        </header>
        <!-- Notification area not used (showMessage function does not display notifications) -->
        <!-- <div id="notificationArea" class="notification" role="status" aria-live="polite"></div> -->

        <!-- Main content -->
        <main class="main-content">
            <!-- Day view -->
            <div id="dayView" class="view-container active">
                <div class="day-all-day-row">
                    <div class="all-day-label" data-view="day">All Day</div>
                    <div id="dayAllDayContainer" class="all-day-events">
                        <!-- All-day events will be generated here -->
                    </div>
                </div>
                <div id="dayEvents" class="day-events">
                    <!-- Time axis (0-23 hours) -->
                    <div class="time-slots">
                        <div class="time-slot" data-hour="4">04:00</div>
                        <div class="time-slot" data-hour="5">05:00</div>
                        <div class="time-slot" data-hour="6">06:00</div>
                        <div class="time-slot" data-hour="7">07:00</div>
                        <div class="time-slot" data-hour="8">08:00</div>
                        <div class="time-slot" data-hour="9">09:00</div>
                        <div class="time-slot" data-hour="10">10:00</div>
                        <div class="time-slot" data-hour="11">11:00</div>
                        <div class="time-slot" data-hour="12">12:00</div>
                        <div class="time-slot" data-hour="13">13:00</div>
                        <div class="time-slot" data-hour="14">14:00</div>
                        <div class="time-slot" data-hour="15">15:00</div>
                        <div class="time-slot" data-hour="16">16:00</div>
                        <div class="time-slot" data-hour="17">17:00</div>
                        <div class="time-slot" data-hour="18">18:00</div>
                        <div class="time-slot" data-hour="19">19:00</div>
                        <div class="time-slot" data-hour="20">20:00</div>
                        <div class="time-slot" data-hour="21">21:00</div>
                        <div class="time-slot" data-hour="22">22:00</div>
                        <div class="time-slot" data-hour="23">23:00</div>
                    </div>
                    <div id="dayEventContainer" class="event-container">
                        <!-- Events will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Week view -->
            <div id="weekView" class="view-container">
                <div class="week-header">
                    <div class="time-column">Time</div>
                    <div class="week-days">
                        <div class="day-header-cell" data-day="0">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="1">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="2">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="3">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="4">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="5">
                            <div class="day-date"></div>
                        </div>
                        <div class="day-header-cell" data-day="6">
                            <div class="day-date"></div>
                        </div>
                    </div>
                </div>
                <div class="week-all-day-row">
                    <div class="time-column" data-view="week">All Day</div>
                    <div class="week-all-day-columns">
                        <div class="all-day-column" data-day="0"></div>
                        <div class="all-day-column" data-day="1"></div>
                        <div class="all-day-column" data-day="2"></div>
                        <div class="all-day-column" data-day="3"></div>
                        <div class="all-day-column" data-day="4"></div>
                        <div class="all-day-column" data-day="5"></div>
                        <div class="all-day-column" data-day="6"></div>
                    </div>
                </div>
                <div id="weekEvents" class="week-events">
                    <!-- Time axis (0-23 hours) -->
                    <div class="time-slots">
                        <div class="time-slot" data-hour="4">04:00</div>
                        <div class="time-slot" data-hour="5">05:00</div>
                        <div class="time-slot" data-hour="6">06:00</div>
                        <div class="time-slot" data-hour="7">07:00</div>
                        <div class="time-slot" data-hour="8">08:00</div>
                        <div class="time-slot" data-hour="9">09:00</div>
                        <div class="time-slot" data-hour="10">10:00</div>
                        <div class="time-slot" data-hour="11">11:00</div>
                        <div class="time-slot" data-hour="12">12:00</div>
                        <div class="time-slot" data-hour="13">13:00</div>
                        <div class="time-slot" data-hour="14">14:00</div>
                        <div class="time-slot" data-hour="15">15:00</div>
                        <div class="time-slot" data-hour="16">16:00</div>
                        <div class="time-slot" data-hour="17">17:00</div>
                        <div class="time-slot" data-hour="18">18:00</div>
                        <div class="time-slot" data-hour="19">19:00</div>
                        <div class="time-slot" data-hour="20">20:00</div>
                        <div class="time-slot" data-hour="21">21:00</div>
                        <div class="time-slot" data-hour="22">22:00</div>
                        <div class="time-slot" data-hour="23">23:00</div>
                    </div>
                    <div class="week-event-container">
                        <div class="week-day" data-day="0">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="1">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="2">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="3">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="4">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="5">
                            <div class="day-events-container"></div>
                        </div>
                        <div class="week-day" data-day="6">
                            <div class="day-events-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Month view -->
            <div id="monthView" class="view-container">
                <div class="month-calendar">
                    <div class="month-weekdays">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    <div id="monthGrid" class="month-grid">
                        <!-- Month calendar dates will be dynamically generated here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Event add/edit form (modal) -->
        <div id="eventModal" class="modal" role="dialog" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Add Event</h2>
                    <button id="closeModal" class="close-btn" aria-label="Close">&times;</button>
                </div>
                <form id="eventForm" class="event-form">
                    <div class="form-section main-section">
                        <div class="form-section past-event-section" id="pastEventSection">
                            <div class="form-group compact">
                                <label>Use Existing Event</label>
                                <div id="pastEventList" class="past-event-list" role="listbox" aria-label="Select an existing event"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="eventTitle">Title *</label>
                            <input type="text" id="eventTitle" name="title" required maxlength="100" aria-required="true">
                        </div>
                        <div class="form-group compact" id="timeInputRow">
                            <label for="eventStartDate">Start Date & Time *</label>
                            <div class="datetime-input-group">
                                <input type="date" id="eventStartDate" name="startDate" required aria-required="true" class="date-input">
                                <div class="time-input-group">
                                    <input type="number" id="eventStartHour" name="startHour" required aria-required="true" class="time-input" min="0" max="23" step="1" placeholder="HH">
                                    <span class="time-separator">:</span>
                                    <input type="number" id="eventStartMinute" name="startMinute" required aria-required="true" class="time-input" min="0" max="45" step="15" placeholder="MM">
                                </div>
                            </div>
                        </div>
                        <div class="form-group compact">
                            <label for="eventEndDate">End Date & Time *</label>
                            <div class="datetime-input-group">
                                <input type="date" id="eventEndDate" name="endDate" required aria-required="true" class="date-input">
                                <div class="time-input-group">
                                    <input type="number" id="eventEndHour" name="endHour" required aria-required="true" class="time-input" min="0" max="23" step="1" placeholder="HH">
                                    <span class="time-separator">:</span>
                                    <input type="number" id="eventEndMinute" name="endMinute" required aria-required="true" class="time-input" min="0" max="45" step="15" placeholder="MM">
                                </div>
                            </div>
                        </div>
                        <div class="form-row all-day-date-row hidden" id="allDayDateRow">
                            <div class="form-group compact">
                                <label for="eventAllDayStart">Start Date *</label>
                                <input type="date" id="eventAllDayStart" name="allDayStart">
                            </div>
                            <div class="form-group compact">
                                <label for="eventAllDayEnd">End Date *</label>
                                <input type="date" id="eventAllDayEnd" name="allDayEnd">
                            </div>
                        </div>
                        <div class="form-group compact">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" name="description" rows="1" maxlength="500" placeholder="Optional"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section options-section">
                        <div class="form-group checkbox-group compact">
                            <label for="eventAllDay" class="checkbox-label">
                                <input type="checkbox" id="eventAllDay" name="allDay">
                                All Day Event
                            </label>
                        </div>
                        <div class="form-group compact">
                            <label>Color</label>
                            <div class="color-picker" role="radiogroup" aria-label="Select event color">
                                <div class="color-choice">
                                    <input type="radio" id="color-blue" name="color" value="#3b82f6" checked>
                                    <label for="color-blue" class="color-option" style="background-color: #3b82f6;" aria-label="Tasks"></label>
                                    <span class="color-label">Tasks</span>
                                </div>
                                <div class="color-choice">
                                    <input type="radio" id="color-green" name="color" value="#10b981">
                                    <label for="color-green" class="color-option" style="background-color: #10b981;" aria-label="Events"></label>
                                    <span class="color-label">Events</span>
                                </div>
                                <div class="color-choice">
                                    <input type="radio" id="color-yellow" name="color" value="#f59e0b">
                                    <label for="color-yellow" class="color-option" style="background-color: #f59e0b;" aria-label="Routines"></label>
                                    <span class="color-label">Routines</span>
                                </div>
                                <div class="color-choice">
                                    <input type="radio" id="color-red" name="color" value="#ef4444">
                                    <label for="color-red" class="color-option" style="background-color: #ef4444;" aria-label="Exercise"></label>
                                    <span class="color-label">Exercise</span>
                                </div>
                                <div class="color-choice">
                                    <input type="radio" id="color-purple" name="color" value="#8b5cf6">
                                    <label for="color-purple" class="color-option" style="background-color: #8b5cf6;" aria-label="Play"></label>
                                    <span class="color-label">Play</span>
                                </div>
                                <div class="color-choice">
                                    <input type="radio" id="color-pink" name="color" value="#ec4899">
                                    <label for="color-pink" class="color-option" style="background-color: #ec4899;" aria-label="Rest"></label>
                                    <span class="color-label">Rest</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row compact-row">
                            <div class="form-group compact">
                                <label for="eventReminder">Reminder</label>
                                <select id="eventReminder" name="reminderMinutes">
                                    <option value="">None</option>
                                    <option value="0">At start time</option>
                                    <option value="5">5 minutes before</option>
                                    <option value="10">10 minutes before</option>
                                    <option value="30">30 minutes before</option>
                                    <option value="60">60 minutes before</option>
                                </select>
                            </div>
                            <div class="form-group compact">
                                <label for="eventRecurrence">Recurrence</label>
                                <select id="eventRecurrence" name="recurrence">
                                    <option value="none">None</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group compact hidden" id="recurrenceEndGroup">
                            <label for="eventRecurrenceEnd">Recurrence End Date</label>
                            <input type="date" id="eventRecurrenceEnd" name="recurrenceEnd">
                        </div>
                    </div>
                    
                    <div class="form-group compact hidden" id="recurringSeriesOptions">
                        <label class="recurring-series-label">Apply to:</label>
                        <div class="recurring-series-options">
                            <label class="recurring-option-label">
                                <input type="radio" name="recurringSeriesAction" value="single" checked>
                                <span class="recurring-option-text">This event only</span>
                            </label>
                            <label class="recurring-option-label">
                                <input type="radio" name="recurringSeriesAction" value="thisAndFuture">
                                <span class="recurring-option-text">This and subsequent events</span>
                            </label>
                            <label class="recurring-option-label">
                                <input type="radio" name="recurringSeriesAction" value="all">
                                <span class="recurring-option-text">All events in series</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="deleteBtn" class="btn btn-danger" style="display: none;">Delete</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation modal -->
        <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
            <div class="modal-content confirm-modal-content">
                <div class="modal-header">
                    <h2 id="confirmTitle">Confirm</h2>
                </div>
                <div class="confirm-body">
                    <p id="confirmMessage"></p>
                </div>
                <div class="form-actions">
                    <button type="button" id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="confirmOkBtn" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p class="loading-text">Processing...</p>
        </div>
    </div>

    <script>
        
        // Unregister Service Worker (just in case)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    <script src="app.js"></script>
</body>
</html>

