# 終日スケジュールに関する問題レポート

## 発見された問題

### 1. 終了日が開始日より前の場合の処理不足（重大）

**場所**: `app.js` 3488-3502行目

**問題**:
- フォーム送信時、`allDayEnd`が`allDayStart`より前の場合、そのまま処理してしまい、`endTime`が`startTime`より前になってしまいます。
- バリデーションでエラーになりますが、ユーザーには分かりにくいです。
- `allDayStartInput`の変更時には、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定していますが、フォーム送信時にはこのチェックがありません。

**現在のコード**:
```javascript
if (isAllDay) {
  const allDayStart = formData.get('allDayStart');
  const allDayEnd = formData.get('allDayEnd') || allDayStart;
  event.startTime = allDayStart ? `${allDayStart}T00:00` : '';
  // 終了日を翌日の00:00に設定（Googleカレンダーの仕様：終了日は「含まない」日として扱われる）
  if (allDayEnd) {
    const [year, month, day] = allDayEnd.split('-').map(Number);
    const endDate = new Date(year, month - 1, day + 1);
    // ... endTimeを設定
  }
}
```

**問題点**:
- `allDayEnd`が`allDayStart`より前の場合、`endTime`が`startTime`より前になってしまいます。
- バリデーション（3125-3126行目）で`end <= start`の場合にエラーになります。

**修正が必要**:
- フォーム送信時、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定するか、エラーメッセージを表示する必要があります。

---

### 2. allDayEndInputの変更時のチェック不足（中程度）

**場所**: `app.js` 3396-3408行目

**問題**:
- `allDayStartInput`の変更時には、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定しています。
- しかし、`allDayEndInput`の変更時には、同様のチェックがありません。

**現在のコード**:
```javascript
if (allDayStartInput) {
  const handler = () => {
    try {
      if (!allDayEndInput || !allDayStartInput.value) return;
      if (!allDayEndInput.value || new Date(allDayEndInput.value) < new Date(allDayStartInput.value)) {
        allDayEndInput.value = allDayStartInput.value;
      }
    } catch (error) {
      console.error('Error in allDayStartInput handler:', error);
    }
  };
  eventListeners.add(allDayStartInput, 'change', handler);
}
```

**問題点**:
- `allDayEndInput`の変更時には、`allDayEnd`が`allDayStart`より前の場合のチェックがありません。

**修正が必要**:
- `allDayEndInput`の変更時にも、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定する必要があります。

---

### 3. Google Apps Scriptとの不整合（中程度）

**場所**: 
- `app.js` 3488-3502行目（フォーム送信時）
- `google-apps-script.js` 297-318行目（Googleカレンダー同期時）

**問題**:
- Google Apps Scriptでは、終了日が開始日と同じまたはそれ以前の場合、開始日の翌日として扱っています（303-305行目）。
- しかし、app.jsでは、`allDayEnd`が`allDayStart`より前の場合、そのまま処理してしまい、バリデーションでエラーになります。

**Google Apps Scriptのコード**:
```javascript
if (isAllDay) {
  const startDate = new Date(start);
  const endDate = new Date(end);
  // 終了日が開始日と同じまたはそれ以前の場合、開始日の翌日として扱う
  if (endDate <= startDate) {
    endDate.setDate(startDate.getDate() + 1);
  }
  event.setAllDayDates(startDate, endDate);
}
```

**問題点**:
- app.jsとGoogle Apps Scriptで処理が異なります。
- app.jsでは、`allDayEnd`が`allDayStart`より前の場合、バリデーションでエラーになりますが、Google Apps Scriptでは自動的に修正されます。

**修正が必要**:
- app.jsでも、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定するか、Google Apps Scriptと同様に処理する必要があります。

---

### 4. バリデーションメッセージの改善（軽微）

**場所**: `app.js` 3125-3126行目

**問題**:
- 終日イベントの場合、終了日を翌日の00:00に設定しているため、`allDayEnd`が`allDayStart`と同じ場合でも、`endTime`は`startTime`より後になります。
- しかし、`allDayEnd`が`allDayStart`より前の場合、`endTime`が`startTime`より前になってしまいます。
- 現在のバリデーションメッセージは「終了日は開始日以降にしてください」ですが、より具体的なメッセージに改善できます。

**現在のコード**:
```javascript
} else if (end <= start) {
  errors.push(event.allDay ? '終了日は開始日以降にしてください' : '終了時刻は開始時刻より後にしてください');
}
```

**修正が必要**:
- 終日イベントの場合、より具体的なメッセージに改善できます（例：「終了日は開始日と同じか、それ以降にしてください」）。

---

## 実施した修正

### ✅ 1. フォーム送信時の終了日チェック追加（3488-3502行目）
- `allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定するように修正しました。
- Google Apps Scriptとの整合性を確保しました。

### ✅ 2. allDayEndInputの変更時のチェック追加（3408行目の後）
- `allDayEndInput`の変更時にも、`allDayEnd`が`allDayStart`より前の場合、`allDayEnd`を`allDayStart`と同じに設定するように修正しました。

### ✅ 3. Google Apps Scriptとの整合性確保
- app.jsでも、`allDayEnd`が`allDayStart`より前の場合、Google Apps Scriptと同様に自動修正するように修正しました。

### ✅ 4. バリデーションメッセージの改善（3125-3126行目）
- 終日イベントの場合、「終了日は開始日と同じか、それ以降にしてください」というより具体的なメッセージに改善しました。

---

## 修正完了日
2025年1月（修正実施済み）

---

## 追加で発見・修正した問題

### ✅ 5. 終日イベントが2日分表示される問題（重大）

**場所**: 
- `app.js` 1556-1566行目（`getEventsByDate`）
- `app.js` 1636-1645行目（`getEventsByWeek`）
- `app.js` 258-262行目（`updateViewsForEvent`）

**問題**:
- 終日イベントの`endTime`は翌日の00:00に設定されている（例：`"2025-01-02T00:00"`）
- しかし、表示時に`endTime.split('T')[0]`で終了日を取得していたため、`"2025-01-02"`として扱われていた
- これにより、1日間の終日イベントが開始日と終了日の両方に表示されてしまっていた

**修正内容**:
- 終日イベントの終了日を取得する際、`endTime`から1日を引いて実際の終了日を計算するように修正
- `getEventsByDate`、`getEventsByWeek`、`updateViewsForEvent`の3箇所を修正

**修正後の動作**:
- `event.startTime = "2025-01-01T00:00"`
- `event.endTime = "2025-01-02T00:00"` (翌日の00:00)
- 実際の終了日 = `"2025-01-01"` (endTimeから1日引いた日付)
- これにより、1日間の終日イベントは1日だけに表示される

**修正日**: 2025年1月（修正実施済み）

